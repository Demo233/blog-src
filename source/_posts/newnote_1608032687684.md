---
title: Apache Druid依赖注入Guice
date: 2020-12-07 21:00:16
categories: 大数据
tags: Apache Druid
---

大数据组件中OLAP引擎应用广泛，比较火的有presto、Kylin、Druid。Presto基于内存处理，HQL用Presto瞬间搞定，猛成一把刀，但你再看看内存使用情况也是把人给惊呆了，真是没有个上百G内存玩不转。再说Kylin和Druid，前者偏离线，后者偏实时。Kylin作为Hadoop领域的老大哥，已经几乎成为离线标准，指标分析领域应用广泛。而Apache Druid则在实时OLAP领域独领风骚，优异的性能、高可用、易拓展。中国平安2019年底引进Druid，到现在已经在路上探索有一年了。离线迎合数仓、实时迎合埋点+Kafka构建OLAP多维分析报表。关于Druid的资料在网上很少，当时接触时，只有英文文档。

关于Druid的源码要是要看懂，得先知道Google Guice这个东西，本文来讨论一下。

### 一、 Google Guice介绍

[Guice](https://github.com/google/guice)是一个小巧的依赖注入工具，玩Java的话，关于Spring依赖注入大家肯定不陌生。早期，Spring依赖注入靠的是写XML，这种方式太过隐蔽。目前Spring依赖注入玩注解，这种方式很灵活。而Guice依赖注入是靠写代码，下面具一些小栗子方便快速入门。

### 二、 Guice实例

**1. 普通注入**

```java
package ml.yihao;

import com.google.inject.*;
import com.google.inject.name.Named;
import com.google.inject.name.Names;

/**
 * @author zyh
 * @Description:
 * @date 2020/12/158:34 下午
 */
public class Example1 {

    public static void main(String[] args) {
        Injector injector = Guice.createInjector(new Module() {
            public void configure(Binder binder) {
                binder.bind(DataBaseMeta.class).to(MysqlDataBaseMeta.class);
                // 注入用户名
                binder.bind(String.class).annotatedWith(Names.named("username")).toInstance("root");
                // 注入密码
                binder.bind(String.class).annotatedWith(Names.named("password")).toInstance("^5g%@!hKH");
            }
        });

        DataBaseMeta dataBaseMeta = injector.getInstance(DataBaseMeta.class);
        dataBaseMeta.print();
    }

}

interface DataBaseMeta{

    void print();
}

@Singleton
class MysqlDataBaseMeta implements DataBaseMeta {


    private String username;
    private String password;

    @Inject
    MysqlDataBaseMeta(@Named("username") String username, @Named("password") String password){
        this.username = username;
        this.password = password;
    }

    public void print() {
        System.out.println(username + ":" + password);
    }
}

```

使用Guice动态注入**username**和**password**属性

**2. 默认与覆盖**

```java
package ml.yihao;

import com.google.common.collect.ImmutableList;
import com.google.inject.Guice;
import com.google.inject.Inject;
import com.google.inject.Injector;
import com.google.inject.Module;
import com.google.inject.util.Modules;

/**
 * @author zyh
 * @Description: 默认注入Mysql，后续覆盖成oracle
 * @date 2020/12/158:48 下午
 */
public class Example2 {

    public static void main(String[] args) {
        ImmutableList<Module> defaultModule = ImmutableList.of(binder -> {
            binder.bind(Database.class).to(MysqlDatabase.class);
        });

        ImmutableList<Module> customModule = ImmutableList.of(binder -> {
            binder.bind(Database.class).to(OracleDatabase.class);
        });

        // 默认
        //Injector injector = Guice.createInjector(defaultModule);

        // 覆盖
        Injector injector = Guice.createInjector(Modules.override(defaultModule).with(customModule));

        FrameWork instance = injector.getInstance(FrameWork.class);
        instance.start();
        
    }
    
}

class FrameWork{

    private Database database;

    @Inject
    FrameWork(Database database){
        this.database = database;
    }

    public void start(){
        database.print();
    }

}

interface Database{
    void print();
}

class MysqlDatabase implements Database {
    private String type = "mysql";

    public void print() {
        System.out.println(type);
    }
}


class OracleDatabase implements Database {
    private String type = "oracle";

    public void print() {
        System.out.println(type);
    }
}

```

**3. **


