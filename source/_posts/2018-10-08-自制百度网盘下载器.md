---
layout: post
title: 自制百度网盘下载器
date: 2018-10-08 00:00:00
categories: 物联网
tags: Raspberry Pi
---

因为想下载一些资料，天天手动下载太麻烦了，于是想着搞一个自动下载工具。

BaiduPCS-Go基于Go语言,仿 Linux shell 文件处理命令，如果会linux使用起来非常得心应手，操作基本相仿。下面结合Raspberry Pi自制一个定时下载器。

构思：定时下载网盘内容到移动硬盘上，实现云盘到移动硬盘的自动同步。

#### 1.到公司,因为公司电脑是window 采用 ssh + wpa_supplicant.conf 配置方式失效，一直扫不到ip

解决办法，接了根网线，查到交换机上，使用 Nmap - Zenmap GUI 扫描最终拿到ip[软件](https://nmap.org/download.html)

扫描指令

```shell
nmap -sn 192.168.0.0/24
```

有类似这样的信息 

> Nmap scan report for 192.168.0.183Host is up (0.0080s latency).MAC Address: B8:27:EB:DB:97:E7 (``Raspberry Pi`` Foundation)

参考博客https://blog.csdn.net/wongnoubo/article/details/79628313

手机端下载Fing 配合Termius可以进行ssh

#### 2.ssh连接respberry以后挂载硬盘，在往硬盘写数据时遇到Permission denied的错误

解决办法,使用下面方式挂再移动硬盘

```shell
$ sudo mount -o uid=pi,gid=pi /dev/sda1 /mnt/1GB_USB_flash
```

但是之后还是不能进行磁盘读写，后续装上驱动解决问题

```shell
$ sudo apt-get install ntfs-3g
```

参考博客
1.https://blog.csdn.net/lovelovelovelovelo/article/details/53862819
2.https://unix.stackexchange.com/questions/195828/permission-denied-on-mounted-devices

#### 3.实现自动下载：使用Bash Shell加入多线程分配任务，遇到困难，文件名中带有空格会下载错误

解决办法还没有,网友提供了利用IFS处理文件名中的空格，但是没成功,后续放弃了这条路，脚本贴出来

```shell
#/bin/bash

# 设置并发的进程数
thread_num=5
a=$(date +%H%M%S)
# mkfifo
tempfifo="my_temp_fifo"
mkfifo ${tempfifo}
# 使文件描述符为非阻塞式
exec 6<>${tempfifo}
rm -f ${tempfifo}

# 为文件描述符创建占位信息
for ((i=1;i<=${thread_num};i++))
do
        {
                echo 
        }
done >&6

exclusion_column="目录总数: 10"

# 这边的sed 是对文件名中可能是空格的进行处理
for line in `BaiduPCS-Go ls| awk '{for(i=1;i<=4;i++){$i=""};print $0}' | sed 's/ /_-_/g'`
#for line in `seq 1 10`
do
        {
                # 解决空格问题
                original_line="$(echo $line | sed s'/_-_/ /g')"
                # 去掉目录最后的分隔符
                original_line=${original_line%*/}
                if [ -n "${original_line}" ];then
                        echo "${original_line} 不为空"
                       if [[ "$original_line" =~ ^目录总数.* ]];then
                               echo "${original_line} 不是目录总数"
                                read -u6
                                {
                                        sleep 1
                                        #echo "${original_line}"
                                        #BaiduPCS-Go d "${line%*/}" &
                                        echo "" >&6
                                } &
                        fi
                fi
        }
done
wait
# 关闭fd6管道
exec 6>&-
b=$(date +%H%M%S)
echo -e "startTime:\t$a"
echo -e "endTime:\t$b"
```

#### 4.使用百度网盘自带API,BaiduPSC d * 这个命令会下载盘内所有数据如果检测到本地磁盘已经存在，就会自动跳过。 

利用上面的机制进行全盘扫描后下载

BaiduPSC相关API链接https://github.com/iikira/BaiduPCS-Go

#### 5.添加日志管理

将日志重定向到myout.file文件中,方便后续管理

```shell
nohup command > myout.file 2>&1 &
```

![image](http://ww1.sinaimg.cn/large/0066vfZIgy1fw0x9n3r63j30sn0jytbu.jpg)

